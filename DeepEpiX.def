Bootstrap: docker
From: python:3.9

%labels
    Author Agn√®s Guinard <agnes.guinard@inserm.fr>
    Version 1.0
    Project DeepEpiX
    Description "Software for annotation and automatic spike detection in MEG recordings"
    BuildDate 2025-06-03

%environment
    export PYTHONDONTWRITEBYTECODE=1
    export PYTHONUNBUFFERED=1
    export VIRTUAL_ENV=/.dashenv
    export PATH="$VIRTUAL_ENV/bin:$PATH"
    export PYTHONPATH=/DeepEpiX/src

%post
    apt-get update && apt-get install -y python3-tk

    # Create virtual environments
    python3 -m venv /.dashenv
    python3 -m venv /.tfenv

    # Upgrade pip and install Dash requirements
    /.dashenv/bin/pip install --upgrade pip
    /.dashenv/bin/pip install -r /DeepEpiX/requirements/requirements-python3.9.txt

    # Install TensorFlow depending on architecture
    OS=$(uname)
    ARCH=$(uname -m)
    echo "$OS - $ARCH"
    if [ "$OS" = "Darwin" ]; then
        echo "Detected macOS ($ARCH). Installing Metal-compatible TensorFlow..."
        /.tfenv/bin/pip install -r /DeepEpiX/requirements/requirements-tfenv-macos.txt
    elif [ "$ARCH" = "x86_64" ] || [ "$ARCH" = "aarch64" ]; then
        echo "Detected Linux ($ARCH). Installing CUDA-compatible TensorFlow..."
        /.tfenv/bin/pip install -r /DeepEpiX/requirements/requirements-tfenv-cuda.txt
    fi

%files
    ./requirements /DeepEpiX/requirements
    ./ /DeepEpiX/

%workdir /DeepEpiX/src

%runscript
    exec /.dashenv/bin/gunicorn -w 25 -b 0.0.0.0:8050 --timeout 600 run:server